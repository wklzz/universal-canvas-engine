<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plugin Example - Universal Canvas Engine</title>
    <script src="https://unpkg.com/fabric@5.0.0/dist/fabric.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #canvas-container {
            border: 1px solid #ccc;
            margin: 20px 0;
        }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #005a9e;
        }
        .controls {
            margin: 20px 0;
        }
        .log {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 20px 0;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Plugin Example - Universal Canvas Engine</h1>
    <p>这是一个插件系统示例，展示如何创建和使用自定义插件。</p>
    
    <div class="controls">
        <button onclick="addShape()">添加图形</button>
        <button onclick="installPlugin()">安装插件</button>
        <button onclick="uninstallPlugin()">卸载插件</button>
        <button onclick="usePluginFeature()">使用插件功能</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <div id="canvas-container">
        <canvas id="canvas" width="800" height="600"></canvas>
    </div>
    
    <h3>插件日志:</h3>
    <div id="log" class="log"></div>

    <!-- 引入 @universal-canvas/engine UMD版本 -->
    <script src="../dist/umd/universal-canvas-engine.js"></script>
    
    <script>
        // 初始化 Fabric.js 画布
        const fabricCanvas = new fabric.Canvas('canvas');
        
        // 创建适配器实例
        const canvasEngine = new FabricAdapter(fabricCanvas);
        
        // 声明全局变量
        let shapeCounter = 0;
        let pluginInstance = null;
        
        // 生成随机颜色
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
        
        // 日志记录函数
        function logMessage(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // 清空日志
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // 自定义插件类
        class LoggingPlugin extends BasePlugin {
            constructor() {
                super('LoggingPlugin', '1.0.0');
                this.logs = [];
            }
            
            install(engine) {
                logMessage(`安装插件 ${this.name} v${this.version}`);
                
                // 保存原始方法
                const originalAddShape = engine.addShape;
                
                // 重写 addShape 方法
                engine.addShape = (shape) => {
                    logMessage(`拦截 addShape 调用: ${JSON.stringify(shape)}`);
                    originalAddShape.call(engine, shape);
                    logMessage(`图形添加完成: ${shape.id}`);
                };
                
                // 添加新的方法
                engine.logStats = () => {
                    logMessage('调用插件添加的方法: logStats');
                    // 这里可以实现统计功能
                    return {
                        message: '这是插件添加的统计功能',
                        timestamp: new Date().toISOString()
                    };
                };
                
                // 添加事件监听器
                const shapeAddedHandler = (shape) => {
                    logMessage(`插件事件处理器: 检测到图形添加 ${shape.id}`);
                };
                
                engine.on('shapeAdded', shapeAddedHandler);
                
                // 保存引用以便卸载时清理
                engine._pluginShapeAddedHandler = shapeAddedHandler;
                engine._originalAddShape = originalAddShape;
            }
            
            uninstall(engine) {
                logMessage(`卸载插件 ${this.name} v${this.version}`);
                
                // 恢复原始方法
                if (engine._originalAddShape) {
                    engine.addShape = engine._originalAddShape;
                }
                
                // 移除事件监听器
                if (engine._pluginShapeAddedHandler) {
                    engine.off('shapeAdded', engine._pluginShapeAddedHandler);
                }
                
                // 移除插件添加的方法
                delete engine.logStats;
                delete engine._pluginShapeAddedHandler;
                delete engine._originalAddShape;
            }
        }
        
        // 添加图形
        function addShape() {
            const id = `shape-${shapeCounter++}`;
            canvasEngine.addShape({
                id: id,
                type: 'rectangle',
                x: Math.random() * 600,
                y: Math.random() * 400,
                width: 50 + Math.random() * 100,
                height: 50 + Math.random() * 100,
                color: getRandomColor()
            });
        }
        
        // 安装插件
        function installPlugin() {
            if (pluginInstance) {
                logMessage('插件已经安装');
                return;
            }
            
            pluginInstance = new LoggingPlugin();
            pluginInstance.install(canvasEngine);
            logMessage('插件安装成功');
        }
        
        // 卸载插件
        function uninstallPlugin() {
            if (!pluginInstance) {
                logMessage('插件未安装');
                return;
            }
            
            pluginInstance.uninstall(canvasEngine);
            pluginInstance = null;
            logMessage('插件卸载成功');
        }
        
        // 使用插件功能
        function usePluginFeature() {
            if (typeof canvasEngine.logStats === 'function') {
                const stats = canvasEngine.logStats();
                logMessage(`插件功能调用结果: ${JSON.stringify(stats)}`);
            } else {
                logMessage('插件未安装或不支持此功能');
            }
        }
    </script>
</body>
</html>